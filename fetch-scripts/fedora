#!/bin/bash

# mirrors.mit.edu is on the IP ACL for fedora-buffet0 here
# so we'll use it. Adjust these values if switching upstreams.
RSYNCSOURCE=rsync://download-i2.fedoraproject.org
MASTERMODULE=fedora-buffet0
PREBITFLIP=1

# The remote module we want to sync from fedora-buffet[0].
# Some call it fedora, others call it fedora-enchilada.
MODULE=fedora

# Normally, quick-fedora-mirror is used to mirror multiple modules,
# and wants DESTD to point at the root. However, we're using it for
# single modules, and it seems to choke on the symlink farm.
# Setting DESTD to the module location and forcing telling qfm to
# put the module in `.`.

DESTD="${MIRRORDIR}/fedora"

TIMEFILE="${MIRRORDIR}/.locks/fedora.timefile"
QFM="./tools/fedora/quick-fedora-mirror"

if ! [ -x "${QFM}" ]; then
    # It is expected that this script is sourced by fetch-hudson
    # and that cwd is the workspace where the root of this repository
    # is checked out.
    echo "Could not find quick-fedora-mirror."
    exit 1
fi

exittrap() { :; }
trap 'exittrap' EXIT

TMPDIR=$(mktemp -d /tmp/fedora.XXXXXX) || die "Unable to mktemp"
exittrap() { rm -rf "${TMPDIR}"; }

CONF="${TMPDIR}/qfm.conf"
cat >"${CONF}" <<EOF
# This will be sourced by qfm, which uses zsh.
# Where our mirrors live
DESTD=${DESTD}
# State regarding last sync, and also a lockfile for qfm
TIMEFILE=${TIMEFILE}
# Upstream mirror that contains MASTERMODULE
REMOTE=${RSYNCSOURCE}
MASTERMODULE=${MASTERMODULE}
PREBITFLIP=${PREBITFLIP}
# Which module to sync
MODULES=(${MODULE})
# Map from module to location; which we're forcing to .
MODULEMAPPING=(${MODULE} .)
# One -v to rsync
VERBOSE=4
EOF

"${QFM}" --config "${CONF}"

rm -rf "${TMPDIR}"
exittrap() { :; }
